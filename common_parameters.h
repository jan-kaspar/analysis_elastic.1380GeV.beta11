double d_RP = 5372.;    // mm

//----------------------------------------------------------------------------------------------------

void Environment::InitNominal()
{
	// beam momentum (GeV)
	p = p_L = p_R = 1380.;

	// momentum uncertainty
	si_de_p = 1E-3 * p;

	// angular (one-side) beam smearing (rad)
	si_th_x = si_th_y = 14E-6;	// TODO: tune

	// vertex smearing (mm)
	si_vtx_x = si_vtx_y = 82E-3;	// TODO: tune

	// pitch-induced error
	si_de_P_L = si_de_P_R = 13E-3;

	// optics - "ideal" from Hubert
	/*
	L_x_L_N = 6.907815061E3; L_x_R_N = 7.123123432E3;		// mm
	L_x_L_F = 4.658536578E3; L_x_R_F = 4.912747084E3;		// mm
	dLds_x_L = 0.; dLds_x_R = 0.;		// 1, TODO

	v_x_L_N = -3.211961106; v_x_R_N = -3.260793214;		// 1
	v_x_L_F = -2.943772831; v_x_R_F = -3.003100052;		// 1
	dvds_x_L = 0.; dvds_x_R = 0.;	// mm^-1, TODO

	L_y_L_N = 20.041446776E3; L_y_R_N = 19.452649165E3;		// mm
	L_y_L_F = 20.067865623E3; L_y_R_F = 19.360612796E3;		// mm
	dLds_y_L = 0.; dLds_y_R = 0.;			// 1m, TODO

	v_y_L_N = -3.241671983; v_y_R_N = -3.188960453;		// 1
	v_y_L_F = -3.51398971; v_y_R_F = -3.45003027;	// 1
	dvds_y_L = 0.; dvds_y_R = 0.;	// mm^-1, TODO
	*/

	// optics - "LSA" from Frici
	L_x_L_N = 6.884559771E3; L_x_R_N = 7.172179152E3;		// mm
	L_x_L_F = 4.672466723E3; L_x_R_F = 4.991454459E3;		// mm
	dLds_x_L = 0.; dLds_x_R = 0.;		// 1, TODO

	v_x_L_N = -3.260370179; v_x_R_N = -3.316633017;			// 1
	v_x_L_F = -2.993070273; v_x_R_F = -3.057205101;			// 1
	dvds_x_L = 0.; dvds_x_R = 0.;	// mm^-1, TODO

	L_y_L_N = 18.34930478E3; L_y_R_N = 17.3359061E3;		// mm
	L_y_L_F = 18.14649368E3; L_y_R_F = 16.95542165E3;		// mm
	dLds_y_L = 0.; dLds_y_R = 0.;			// 1m, TODO

	v_y_L_N = -3.158725686; v_y_R_N = -3.073783955;			// 1
	v_y_L_F = -3.416576076; v_y_R_F = -3.316198338;			// 1
	dvds_y_L = 0.; dvds_y_R = 0.;	// mm^-1, TODO

	// optics imperfections
	double opt_cov_data[] = {
		5.05518E-02,    1.08719E-01,    0.00000E+00,    0.00000E+00,    4.63309E-02,    7.33189E-02,    0.00000E+00,    0.00000E+00,	0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,
		1.08719E-01,    2.33818E-01,    0.00000E+00,    0.00000E+00,    9.96417E-02,    1.57684E-01,    0.00000E+00,    0.00000E+00,	0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,
		0.00000E+00,    0.00000E+00,    5.14913E-02,    3.18342E-01,    0.00000E+00,    0.00000E+00,    5.58169E-02,    3.18762E-01,	0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,
		0.00000E+00,    0.00000E+00,    3.18342E-01,    1.96813E+00,    0.00000E+00,    0.00000E+00,    3.45085E-01,    1.97073E+00,	0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,
		4.63309E-02,    9.96417E-02,    0.00000E+00,    0.00000E+00,    4.24624E-02,    6.71970E-02,    0.00000E+00,    0.00000E+00,	0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,
		7.33189E-02,    1.57684E-01,    0.00000E+00,    0.00000E+00,    6.71970E-02,    1.06340E-01,    0.00000E+00,    0.00000E+00,	0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,
		0.00000E+00,    0.00000E+00,    5.58169E-02,    3.45085E-01,    0.00000E+00,    0.00000E+00,    6.05058E-02,    3.45540E-01,	0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,
		0.00000E+00,    0.00000E+00,    3.18762E-01,    1.97073E+00,    0.00000E+00,    0.00000E+00,    3.45540E-01,    1.97332E+00,	0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,
		0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,				5.05518E-02,    1.08719E-01,    0.00000E+00,    0.00000E+00,    4.63309E-02,    7.33189E-02,    0.00000E+00,    0.00000E+00,
		0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,				1.08719E-01,    2.33818E-01,    0.00000E+00,    0.00000E+00,    9.96417E-02,    1.57684E-01,    0.00000E+00,    0.00000E+00,
		0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.00000E+00,    0.00000E+00,    5.14913E-02,    3.18342E-01,    0.00000E+00,    0.00000E+00,    5.58169E-02,    3.18762E-01,
		0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.00000E+00,    0.00000E+00,    3.18342E-01,    1.96813E+00,    0.00000E+00,    0.00000E+00,    3.45085E-01,    1.97073E+00,
		0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,				4.63309E-02,    9.96417E-02,    0.00000E+00,    0.00000E+00,    4.24624E-02,    6.71970E-02,    0.00000E+00,    0.00000E+00,
		0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,				7.33189E-02,    1.57684E-01,    0.00000E+00,    0.00000E+00,    6.71970E-02,    1.06340E-01,    0.00000E+00,    0.00000E+00,
		0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.00000E+00,    0.00000E+00,    5.58169E-02,    3.45085E-01,    0.00000E+00,    0.00000E+00,    6.05058E-02,    3.45540E-01,
		0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.,				0.00000E+00,    0.00000E+00,    3.18762E-01,    1.97073E+00,    0.00000E+00,    0.00000E+00,    3.45540E-01,    1.97332E+00
	};
	opt_cov.SetMatrixArray(opt_cov_data);

	TMatrixDSymEigen eig_decomp(opt_cov);
	TVectorD eig_values(eig_decomp.GetEigenValues());
	//eig_values.Print();
	TMatrixDSym S(16);
	for (unsigned int i = 0; i < 16; i++)
		S(i, i) = (eig_values(i) >= 0.) ? sqrt(eig_values(i)) : 0.;
	opt_per_gen = eig_decomp.GetEigenVectors() * S;

	// alignment uncertainties - TODO: just first-guess values
	si_de_x = 30E-3;
	si_de_y = 100E-3;
	si_tilt = 2E-3;
}

//----------------------------------------------------------------------------------------------------

void Environment::UseMatchedOptics()
{
	printf(">> Environment::UseMatchedOptics\n");
	printf("\tmatched optics sent by Frici on 5 December 2014\n");

	// optics
	L_x_L_N = 6.87353459063193E3;		L_x_R_N = 7.60784954570175E3;		// mm
	L_x_L_F = 4.67122752829455E3;		L_x_R_F = 5.39814119130216E3;		// mm

	v_x_L_N = -3.26320069936203;		v_x_R_N = -3.31526333641205;		// 1
	v_x_L_F = -2.99695272612671;		v_x_R_F = -3.05718144832542;		// 1

	L_y_L_N = 21.0340577056862E3;		L_y_R_N = 18.4622954029043E3;		// mm
	L_y_L_F = 21.0241727209307E3;		L_y_R_F = 18.1575636325767E3;		// mm

	v_y_L_N = -3.08643256412104;		v_y_R_N = -3.04123865185638;		// 1
	v_y_L_F = -3.33964076683465;		v_y_R_F = -3.28148802305783;		// 1

	/*
	printf("\tcovariance matrix sent by Frici on 31 January 2014, scaled by (1.35)^2\n");

	// L's in m, v's in 1
	double opt_cov_data[] = {
		7.79924295E-06, 1.43015767E-05, -5.41575923E-05, -1.21807517E-03, 7.81863435E-06, -2.49881153E-07, -6.00960263E-05, -1.32345029E-03, 6.97902683E-06, 1.55856920E-05, -5.42228378E-05, -1.22680312E-03, 7.64961570E-06, 2.29722480E-07, -6.01754873E-05, -1.32406994E-03,
		1.43015767E-05, 3.60175208E-05, -1.14158302E-04, -2.50043355E-03, 1.68904562E-05, 4.19360895E-07, -1.26698560E-04, -2.67563048E-03, 1.54708562E-05, 3.41879130E-05, -1.14140988E-04, -2.48731155E-03, 1.70479019E-05, -1.20749009E-07, -1.26666848E-04, -2.67546645E-03,
		-5.41575923E-05, -1.14158302E-04, 5.23042920E-04, 1.32510877E-02, -5.89824788E-05, 1.29170234E-06, 5.80537328E-04, 1.44268553E-02, -5.40553500E-05, -1.14818594E-04, 5.19917333E-04, 1.32383849E-02, -5.80832573E-05, -1.35582154E-06, 5.77065465E-04, 1.44279853E-02,
		-1.21807517E-03, -2.50043355E-03, 1.32510877E-02, 3.53845665E-01, -1.31024081E-03, 2.09744235E-05, 1.47085592E-02, 3.86787353E-01, -1.22389076E-03, -2.50644780E-03, 1.32023176E-02, 3.53503035E-01, -1.29613649E-03, -2.38536090E-05, 1.46542669E-02, 3.86756370E-01,
		7.81863435E-06, 1.68904562E-05, -5.89824788E-05, -1.31024081E-03, 8.59511048E-06, -2.58375825E-07, -6.54567278E-05, -1.41163378E-03, 7.64259908E-06, 1.71995157E-05, -5.85642150E-05, -1.31013693E-03, 8.40945240E-06, 2.57382563E-07, -6.49929015E-05, -1.41235184E-03,
		-2.49881153E-07, 4.19360895E-07, 1.29170234E-06, 2.09744235E-05, -2.58375825E-07, 7.25050643E-07, 1.43232280E-06, 2.21852925E-05, 1.74435667E-07, -3.24556268E-07, 1.04949209E-07, 2.08275300E-05, 1.62823790E-07, -5.19667650E-07, 1.18107113E-07, 2.35915335E-05,
		-6.00960263E-05, -1.26698560E-04, 5.80537328E-04, 1.47085592E-02, -6.54567278E-05, 1.43232280E-06, 6.44352165E-04, 1.60136150E-02, -5.99901390E-05, -1.27419723E-04, 5.77069110E-04, 1.46943619E-02, -6.44596380E-05, -1.50385410E-06, 6.40497578E-04, 1.60148725E-02,
		-1.32345029E-03, -2.67563048E-03, 1.44268553E-02, 3.86787353E-01, -1.41163378E-03, 2.21852925E-05, 1.60136150E-02, 4.23060570E-01, -1.32098627E-03, -2.69564153E-03, 1.43815298E-02, 3.86539493E-01, -1.39692256E-03, -2.51065778E-05, 1.59632228E-02, 4.23022298E-01,
		6.97902683E-06, 1.54708562E-05, -5.40553500E-05, -1.22389076E-03, 7.64259908E-06, 1.74435667E-07, -5.99901390E-05, -1.32098627E-03, 7.77166853E-06, 1.43271281E-05, -5.41067445E-05, -1.21509538E-03, 7.78748783E-06, -2.02430543E-07, -6.00389820E-05, -1.32029737E-03,
		1.55856920E-05, 3.41879130E-05, -1.14818594E-04, -2.50644780E-03, 1.71995157E-05, -3.24556268E-07, -1.27419723E-04, -2.69564153E-03, 1.43271281E-05, 3.63594218E-05, -1.14906803E-04, -2.51842163E-03, 1.69218396E-05, 5.76629888E-07, -1.27528526E-04, -2.69534993E-03,
		-5.42228378E-05, -1.14140988E-04, 5.19917333E-04, 1.32023176E-02, -5.85642150E-05, 1.04949209E-07, 5.77069110E-04, 1.43815298E-02, -5.41067445E-05, -1.14906803E-04, 5.20793955E-04, 1.32014975E-02, -5.85609345E-05, -1.35814887E-07, 5.78036858E-04, 1.43787778E-02,
		-1.22680312E-03, -2.48731155E-03, 1.32383849E-02, 3.53503035E-01, -1.31013693E-03, 2.08275300E-05, 1.46943619E-02, 3.86539493E-01, -1.21509538E-03, -2.51842163E-03, 1.32014975E-02, 3.53417378E-01, -1.29578110E-03, -2.37579278E-05, 1.46534468E-02, 3.86534025E-01,
		7.64961570E-06, 1.70479019E-05, -5.80832573E-05, -1.29613649E-03, 8.40945240E-06, 1.62823790E-07, -6.44596380E-05, -1.39692256E-03, 7.78748783E-06, 1.69218396E-05, -5.85609345E-05, -1.29578110E-03, 8.54767080E-06, -1.80909369E-07, -6.49881630E-05, -1.39597121E-03,
		2.29722480E-07, -1.20749009E-07, -1.35582154E-06, -2.38536090E-05, 2.57382563E-07, -5.19667650E-07, -1.50385410E-06, -2.51065778E-05, -2.02430543E-07, 5.76629888E-07, -1.35814887E-07, -2.37579278E-05, -1.80909369E-07, 7.22590268E-07, -1.52653147E-07, -2.67716138E-05,
		-6.01754873E-05, -1.26666848E-04, 5.77065465E-04, 1.46542669E-02, -6.49929015E-05, 1.18107113E-07, 6.40497578E-04, 1.59632228E-02, -6.00389820E-05, -1.27528526E-04, 5.78036858E-04, 1.46534468E-02, -6.49881630E-05, -1.52653147E-07, 6.41571030E-04, 1.59601793E-02,
		-1.32406994E-03, -2.67546645E-03, 1.44279853E-02, 3.86756370E-01, -1.41235184E-03, 2.35915335E-05, 1.60148725E-02, 4.23022298E-01, -1.32029737E-03, -2.69534993E-03, 1.43787778E-02, 3.86534025E-01, -1.39597121E-03, -2.67716138E-05, 1.59601793E-02, 4.23024120E-01
	};
	opt_cov.SetMatrixArray(opt_cov_data);

	TMatrixDSymEigen eig_decomp(opt_cov);
	TVectorD eig_values(eig_decomp.GetEigenValues());
	TMatrixDSym S(16);
	for (unsigned int i = 0; i < 16; i++)
		S(i, i) = (eig_values(i) >= 0.) ? sqrt(eig_values(i)) : 0.;
	opt_per_gen = eig_decomp.GetEigenVectors() * S;
	*/
}
